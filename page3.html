<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë¦¬ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ìë¦¬ ì˜ˆì•½ ì „ìš© ìŠ¤íƒ€ì¼ */
        .time-display {
            font-size: 20px;
            font-weight: bold;
            color: #2196F3;
            text-align: center;
            margin: 10px 0;
        }
        
        .time-info {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .seat-layout {
            margin: 30px 0;
        }
        
        .seat-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-width: 480px;
            margin: 0 auto;
        }
        
        .seat {
            width: 60px;
            height: 60px;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .seat.available {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .seat.available:hover {
            background-color: #45a049;
        }
        
        .seat.reserved {
            background-color: #f44336;
            color: white;
            border-color: #f44336;
            cursor: not-allowed;
        }
        
        .seat.my-reservation {
            background-color: #FF9800;
            color: white;
            border-color: #FF9800;
        }
        
        .seat.my-reservation:hover {
            background-color: #F57C00;
        }
        
        .seat.unavailable {
            background-color: #9E9E9E;
            color: white;
            border-color: #9E9E9E;
            cursor: not-allowed;
        }
        
        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .user-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background-color: #757575;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #616161;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="page-title">ìë¦¬ ì˜ˆì•½ ì‹œìŠ¤í…œ</div>
    
    <div class="time-display" id="currentTime"></div>
    <div class="time-info" id="timeInfo"></div>
    
    <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
    <div id="loginSection">
        <div class="content-box">
            <div class="login-form">
                <div class="form-group">
                    <label for="studentId">í•™ë²ˆ</label>
                    <input type="text" id="studentId" placeholder="í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label for="studentName">ì´ë¦„</label>
                    <input type="text" id="studentName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label for="authCode">ì¸ì¦ë²ˆí˜¸</label>
                    <input type="password" id="authCode" placeholder="ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button class="main-button" onclick="login()">ë¡œê·¸ì¸</button>
            </div>
        </div>
        
        <div class="button-group">
            <button class="main-button" onclick="location.href='index.html'">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>
    
    <!-- ì˜ˆì•½ ì„¹ì…˜ -->
    <div id="reservationSection" class="hidden">
        <div class="user-info" id="userInfo"></div>
        
        <div class="seat-legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4CAF50;"></div>
                <span>ì˜ˆì•½ ê°€ëŠ¥</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f44336;"></div>
                <span>ì˜ˆì•½ë¨</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FF9800;"></div>
                <span>ë‚´ ì˜ˆì•½</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #9E9E9E;"></div>
                <span>ì‚¬ìš©ë¶ˆê°€</span>
            </div>
        </div>
        
        <div class="seat-layout">
            <div class="seat-grid" id="seatGrid"></div>
        </div>
        
        <div class="button-group">
            <button class="main-button" onclick="refreshSeatLayout()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="main-button btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            <button class="main-button" onclick="location.href='index.html'">ë©”ì¸ìœ¼ë¡œ</button>
        </div>
    </div>
    
    <div id="messageArea"></div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwjmrNSS1r4oUbuBOLvhB1tOhhtrwY7koMbYILCHEVtLTnxmytxNX3FUpcwVKWlrYsp5Q/exec';
        
        let currentUser = null;
        let currentUserReservation = null;
        let seatData = [];
        
        // Google Apps Script í˜¸ì¶œ í—¬í¼ í•¨ìˆ˜
        function callGAS(action, params = {}) {
            return fetch(SCRIPT_URL + '?' + new URLSearchParams({action, ...params}))
                .then(response => response.json());
        }
        
        // ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateTime() {
            fetch(SCRIPT_URL + '?action=checkReservationTime')
                .then(response => response.json())
                .then(timeData => {
                    document.getElementById('currentTime').textContent = timeData.currentTime;
                    document.getElementById('timeInfo').textContent = 
                        `ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„: ${timeData.startTime} ~ ${timeData.endTime}`;
                })
                .catch(error => {
                    console.error('ì‹œê°„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                });
        }
        
        // ë¡œê·¸ì¸
        function login() {
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const authCode = document.getElementById('authCode').value.trim();
            
            if (!studentId || !studentName || !authCode) {
                showMessage('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            fetch(SCRIPT_URL + '?' + new URLSearchParams({
                action: 'authenticateStudent',
                studentId: studentId,
                name: studentName,
                authCode: authCode
            }))
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    currentUser = {
                        id: studentId,
                        name: studentName
                    };
                    showMessage(result.message, 'success');
                    showReservationSection();
                    loadSeatLayout();
                } else {
                    showMessage(result.message, 'error');
                }
            })
            .catch(error => {
                showMessage('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                console.error(error);
            });
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            currentUser = null;
            currentUserReservation = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('reservationSection').classList.add('hidden');
            document.getElementById('studentId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('authCode').value = '';
            clearMessages();
        }
        
        // ì˜ˆì•½ ì„¹ì…˜ í‘œì‹œ
        function showReservationSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('reservationSection').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 
                `${currentUser.name}(${currentUser.id})ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
        }
        
        // ìë¦¬ ë°°ì¹˜ë„ ë¡œë“œ
        function loadSeatLayout() {
            fetch(SCRIPT_URL + '?action=getSeatLayout')
                .then(response => response.json())
                .then(data => {
                    seatData = data;
                    return fetch(SCRIPT_URL + '?' + new URLSearchParams({
                        action: 'getStudentReservation',
                        studentId: currentUser.id
                    }));
                })
                .then(response => response.json())
                .then(reservation => {
                    currentUserReservation = reservation;
                    renderSeatLayout();
                })
                .catch(error => {
                    showMessage('ìë¦¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    console.error(error);
                });
        }
        
        // ìë¦¬ ë°°ì¹˜ë„ ë Œë”ë§
        function renderSeatLayout() {
            const seatGrid = document.getElementById('seatGrid');
            seatGrid.innerHTML = '';
            
            seatData.forEach((row, rowIndex) => {
                row.forEach((seat, colIndex) => {
                    const seatElement = document.createElement('div');
                    seatElement.className = 'seat';
                    
                    if (!seat.available) {
                        seatElement.classList.add('unavailable');
                        seatElement.textContent = 'X';
                    } else if (seat.reserved && seat.reservedBy == currentUser.id) {
                        seatElement.classList.add('my-reservation');
                        seatElement.textContent = 'ë‚´ ìë¦¬';
                        seatElement.onclick = () => cancelSeat(seat.position);
                    } else if (seat.reserved) {
                        seatElement.classList.add('reserved');
                        seatElement.textContent = 'ì˜ˆì•½ë¨';
                        seatElement.onclick = () => showMessage('ì´ë¯¸ ì„ íƒëœ ìë¦¬ì…ë‹ˆë‹¤.', 'error');
                    } else {
                        seatElement.classList.add('available');
                        seatElement.textContent = 'ê°€ëŠ¥';
                        seatElement.onclick = () => reserveSeat(seat.position);
                    }
                    
                    seatGrid.appendChild(seatElement);
                });
            });
        }
        
        // ìë¦¬ ì˜ˆì•½
        function reserveSeat(seatPosition) {
            if (currentUserReservation) {
                showMessage('ì´ë¯¸ ì„ íƒí•œ ìë¦¬ê°€ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (confirm('ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch(SCRIPT_URL + '?' + new URLSearchParams({
                    action: 'reserveSeat',
                    studentId: currentUser.id,
                    seatPosition: seatPosition
                }))
                .then(response => response.json())
                .then(result => {
                    showMessage(result.message, result.success ? 'success' : 'error');
                    if (result.success) {
                        currentUserReservation = seatPosition;
                        loadSeatLayout();
                    }
                })
                .catch(error => {
                    showMessage('ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    console.error(error);
                });
            }
        }
        
        // ìë¦¬ ì·¨ì†Œ
        function cancelSeat(seatPosition) {
            if (confirm('ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch(SCRIPT_URL + '?' + new URLSearchParams({
                    action: 'cancelReservation',
                    studentId: currentUser.id,
                    seatPosition: seatPosition
                }))
                .then(response => response.json())
                .then(result => {
                    showMessage(result.message, result.success ? 'success' : 'error');
                    if (result.success) {
                        currentUserReservation = null;
                        loadSeatLayout();
                    }
                })
                .catch(error => {
                    showMessage('ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    console.error(error);
                });
            }
        }
        
        // ìë¦¬ ë°°ì¹˜ë„ ìƒˆë¡œê³ ì¹¨
        function refreshSeatLayout() {
            showMessage('ìë¦¬ í˜„í™©ì„ ì—…ë°ì´íŠ¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'success');
            loadSeatLayout();
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'loading-text' : 'error-text';
            messageDiv.textContent = message;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }
        
        // ë©”ì‹œì§€ ì´ˆê¸°í™”
        function clearMessages() {
            document.getElementById('messageArea').innerHTML = '';
        }
        
        // Enter í‚¤ ì´ë²¤íŠ¸
        document.getElementById('authCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        // ì´ˆê¸°í™”
        updateTime();
        setInterval(updateTime, 1000);
    </script>
</body>
</html>
